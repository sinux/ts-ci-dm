# Javascript Node CircleCI 2.0 configuration file
#
# Check https://circleci.com/docs/2.0/language-javascript/ for more details
#
---
version: 2
jobs:
  build:
    docker:
      # specify the version you desire here
    - image: circleci/node:7.10
  
      # Specify service dependencies here if necessary
      # CircleCI maintains a library of pre-built images
      # documented at https://circleci.com/docs/2.0/circleci-images/
      # - image: circleci/mongo:3.4.4

      working_directory: /home/circleci/repo

    steps:
    - checkout

      # Download and cache dependencies
    - restore_cache:
        keys:
        - v1-dependencies-{{ checksum "package.json" }}
          # fallback to using the latest cache if no exact match is found
        - v1-dependencies-

    - run: npm install

    - save_cache:
        paths:
        - node_modules
        key: v1-dependencies-{{ checksum "package.json" }}
        
      # run tests!
    - run: npm test

    - persist_to_workspace:
        root: .
        paths: .


  push:
    docker:
    - image: docker.io/library/golang:alpine
    working_directory: /home/circleci/repo
    tag: /v[0-9]+(\.[0-9]+)*/
    steps:
    - run:
        name: Install dependencies
        command: |
          apk update
          apk add --no-progress ca-certificates curl
          apk add git make
          apk add openssh
          apk add zip
          go get github.com/aktau/github-release
          apk add --update nodejs nodejs-npm
          npm install github-release-notes -g
    - attach_workspace:
        at: /home/circleci/repo
    - run:
        name: push to master
        command: |
          zip -r $CIRCLE_ARTIFACTS/$PROJECT_NAME-$CIRCLE_TAG.zip out/*
          git config user.name $CIRCLE_PROJECT_USERNAME
          gren changelog
          github-release upload --user $CIRCLE_PROJECT_USERNAME --repo $CIRCLE_PROJECT_REPONAME --tag $CIRCLE_TAG --name $CIRCLE_PROJECT_REPONAME"."$CIRCLE_TAG"-build-"$CIRCLE_BUILD_NUM".zip" --file $CIRCLE_ARTIFACTS/$PROJECT_NAME-$CIRCLE_TAG.zip



workflows:

  version: 2

  build-workflow:

    jobs:

    - build:
        filters:
          branches:
            only: develop
    - push:
        requires:
        - build
...


